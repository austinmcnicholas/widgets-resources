// This file was generated by Mendix Studio Pro.
//
// WARNING: Only the following code will be retained when actions are regenerated:
// - the import list
// - the code between BEGIN USER CODE and END USER CODE
// - the code between BEGIN EXTRA CODE and END EXTRA CODE
// Other code you write will be lost the next time you deploy the project.
import fetchBlob from "rn-fetch-blob";

// BEGIN EXTRA CODE
function formatMendixFileUrl(file: mendix.lib.MxObject): string {
    return `${mx.remoteUrl}file?guid=${file.getGuid()}&changedDate=${
        file.get("changedDate") ?? ""
    }&name=${encodeURIComponent(file.get("Name"))}`;
}

function formatPath(...pathArgs: string[]): string {
    return pathArgs.filter(arg => !!arg).join("/");
}

function sanitizeFileName(name: string) {
    return name.replace(/[<>"?:|*\/\\\u0000-\u001F\u007F]/g, "_");
}
// END EXTRA CODE

/**
 * @param {MxObject} file
 * @param {string} filePath - optional
 * @returns {Promise.<boolean>}
 */
export async function DownloadFile(file: mendix.lib.MxObject, filePath: string): Promise<boolean> {
    // BEGIN USER CODE
    if (!file) {
        return Promise.reject(new Error("Input parameter 'file' is required"));
    }
    const dirs = fetchBlob.fs.dirs;
    try {
        const fileName = file.get("Name") as string;
        const sanitizedFileName = sanitizeFileName(fileName);
        await fetchBlob
            .config({
                path: formatPath(dirs.DownloadDir, filePath, sanitizedFileName)
            })
            .fetch("GET", formatMendixFileUrl(file));
        return Promise.resolve(true);
    } catch (err) {
        console.error("error", err);
        return Promise.resolve(false);
    }
    // END USER CODE
}
